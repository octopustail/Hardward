<!DOCTYPE html>
<meta charset="utf-8">
<canvas width="300" height="300"></canvas>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
var Json = [{"_id":"5caf26cb8fd84281dc60f986","inst_name":"ins_456505426","task_name":"J2_1_3","job_name":"j_3834827","task_type":"1","status":"Terminated","start_time":165845,"end_time":165967,"machine_id":"m_3040","seq_no":1,"total_seq_no":1,"cpu_avg":2,"cpu_max":57,"mem_avg":0.42,"mem_max":0.42},{"_id":"5caf26cb8fd84281dc60f987","inst_name":"ins_308715900","task_name":"J4_2_3","job_name":"j_3834827","task_type":"1","status":"Terminated","start_time":165845,"end_time":165967,"machine_id":"m_3625","seq_no":1,"total_seq_no":1,"cpu_avg":2,"cpu_max":76,"mem_avg":0.02,"mem_max":0.02},{"_id":"5caf26cb8fd84281dc60f988","inst_name":"ins_308715715","task_name":"J4_2_3","job_name":"j_3834827","task_type":"1","status":"Terminated","start_time":165845,"end_time":165967,"machine_id":"m_2129","seq_no":1,"total_seq_no":1,"cpu_avg":2,"cpu_max":72,"mem_avg":0.02,"mem_max":0.02},{"_id":"5caf26cb8fd84281dc60f989","inst_name":"ins_648533336","task_name":"R6_5","job_name":"j_3834827","task_type":"1","status":"Terminated","start_time":165845,"end_time":165967,"machine_id":"m_1755","seq_no":1,"total_seq_no":1,"cpu_avg":1,"cpu_max":88,"mem_avg":0.04,"mem_max":0.04},{"_id":"5caf26cb8fd84281dc60f98a","inst_name":"ins_308715807","task_name":"J4_2_3","job_name":"j_3834827","task_type":"1","status":"Terminated","start_time":165845,"end_time":165967,"machine_id":"m_2339","seq_no":1,"total_seq_no":1,"cpu_avg":6,"cpu_max":44,"mem_avg":0.03,"mem_max":0.03},{"_id":"5caf26cb8fd84281dc60f98b","inst_name":"ins_456505240","task_name":"J2_1_3","job_name":"j_3834827","task_type":"1","status":"Terminated","start_time":165845,"end_time":165967,"machine_id":"m_963","seq_no":1,"total_seq_no":1,"cpu_avg":2,"cpu_max":84,"mem_avg":0.41,"mem_max":0.42},{"_id":"5caf26cb8fd84281dc60f98c","inst_name":"ins_456505514","task_name":"J2_1_3","job_name":"j_3834827","task_type":"1","status":"Terminated","start_time":165845,"end_time":165967,"machine_id":"m_3942","seq_no":1,"total_seq_no":1,"cpu_avg":2,"cpu_max":80,"mem_avg":0.41,"mem_max":0.42},{"_id":"5caf26cb8fd84281dc60f98d","inst_name":"ins_308715996","task_name":"J4_2_3","job_name":"j_3834827","task_type":"1","status":"Terminated","start_time":165845,"end_time":165967,"machine_id":"m_1955","seq_no":1,"total_seq_no":1,"cpu_avg":1,"cpu_max":100,"mem_avg":0.02,"mem_max":0.02},{"_id":"5caf26cb8fd84281dc60f98f","inst_name":"ins_774120321","task_name":"M1","job_name":"j_3834827","task_type":"1","status":"Terminated","start_time":165845,"end_time":165967,"machine_id":"m_2016","seq_no":1,"total_seq_no":1,"cpu_avg":101,"cpu_max":147,"mem_avg":0.02,"mem_max":0.02},{"_id":"5caf26cb8fd84281dc60f990","inst_name":"ins_308715612","task_name":"J4_2_3","job_name":"j_3834827","task_type":"1","status":"Terminated","start_time":165845,"end_time":165967,"machine_id":"m_283","seq_no":1,"total_seq_no":1,"cpu_avg":9,"cpu_max":100,"mem_avg":0.04,"mem_max":0.04},{"_id":"5caf26cb8fd84281dc60f991","inst_name":"ins_498892046","task_name":"R5_4","job_name":"j_3834827","task_type":"1","status":"Terminated","start_time":165845,"end_time":165967,"machine_id":"m_2550","seq_no":1,"total_seq_no":1,"cpu_avg":7,"cpu_max":54,"mem_avg":0.08,"mem_max":0.08}]
var nodesProcess = function(Json){

var exist = new Array();

var index = new Array()

// for(let i in list){
    // let field = 'inst_name';
//在开头插入一个源节点origin
// var origin = 'origin'
// index.unshift('origin')
// index.unshift(0)

//////////////////////////////
for(let j in Json){
    if(exist.indexOf(Json[j].inst_name )== -1){
        index.push(Json[j].inst_name);//小改改;
        exist.push(Json[j].inst_name);
    }
}
// }


for(let j in Json){
    if(exist.indexOf(Json[j].task_name )== -1){
        index.push(Json[j].task_name);//小改改;
        exist.push(Json[j].task_name);
    }
}



for(let j in Json){
    if(exist.indexOf(Json[j].job_name )== -1){
        index.push(Json[j].job_name);//小改改;
        exist.push(Json[j].job_name);
    }
}

//以下根据index数组构造映射表
    map = d3.range(index.length).map(function(i){
    return{
        tom :i,
        jerry:index[i]
    }
})

var data = new Array()
for(let a in index){
    let object = new Object()
    object.index = a;//要点：不用映射，直接写进去（因为之前也是按顺序的）
    data.push(object)
}
var nodes0 = JSON.stringify(data)
var dnodes = JSON.parse(nodes0)

console.log(index);
return dnodes;
}








var linksProcess = function(Json){

let exist = new Array();

//添加origin节点的link
let data0 = new Array();
// var obj0  = new Object();
// obj0.source = 0;
// obj0.target = 'origin';

// data0.push(obj0);
// for(let i in Json){
//     if(exist.indexOf(Json[i].job_name) == -1){
//         exist.push(Json[i].job_name)
//         let a = new Object();
//         a.source = 'origin';
//         a.target = Json[i].job_name;

//         data0.push(a)

//     }
// }



let data1 = new Array();

for(let i in Json){
    let job = Json[i].job_name;
    let task = Json[i].task_name;
    let a = new Object();
    a.source = job;
    a.target = task;

    data1.push(a);


}

    var data2 = data0.concat(data1)

let data3 = new Array();
for(let i in Json){
    let task = Json[i].task_name;
    let instance = Json[i].inst_name;
    let a = new Object();
    a.source = task;
    a.target = instance;

    data3.push(a);
}
var data = data2.concat(data3)



var links0 = JSON.stringify(data);
var links = JSON.parse(links0);

//对links去重，赋值给dlinks
var source = new Array();	
var target = new Array();

var dlinks = new Array();

for(let k = 0;k<links.length;k++){

if((source.indexOf(links[k].source) > -1)&(target.indexOf(links[k].target) > -1)){

}else{
    source.push(links[k].source);
    target.push(links[k].target);
    dlinks.push(links[k])

}
}

//以下把links根据映射表来映射
for(let i=0;i<dlinks.length;i++){
    for(let j=0;j<map.length;j++){
        if(dlinks[i].source == map[j].jerry){
            dlinks[i].source = map[j].tom;
        }else{

        }

        if(dlinks[i].target == map[j].jerry){
            dlinks[i].target = map[j].tom;
        }else{
            
        }
    }
}


console.log(map);
console.log(dlinks);

return dlinks;

}


var nodes = nodesProcess(Json)
var links = linksProcess(Json)

console.log(nodes);
console.log(links);


var simulation = d3.forceSimulation(nodes)
    .force("charge", d3.forceManyBody())
    .force("link", d3.forceLink(links).distance(20).strength(1))
    .force("x", d3.forceX())
    .force("y", d3.forceY())
    .on("tick", ticked);

var canvas = document.querySelector("canvas"),
    context = canvas.getContext("2d"),
    width = canvas.width,
    height = canvas.height;

d3.select(canvas)
    .call(d3.drag()
        .container(canvas)
        .subject(dragsubject)
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended));

function ticked() {
  context.clearRect(0, 0, width, height);
  context.save();
  context.translate(width / 2, height / 2);

  context.beginPath();
  links.forEach(drawLink);
  context.strokeStyle = "#aaa";
  context.stroke();

  context.beginPath();
  nodes.forEach(drawNode);
  context.fill();
  context.strokeStyle = "#fff";
  context.stroke();

  context.restore();
}

function dragsubject() {
  return simulation.find(d3.event.x - width / 2, d3.event.y - height / 2);
}

function dragstarted() {
  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
  d3.event.subject.fx = d3.event.subject.x;
  d3.event.subject.fy = d3.event.subject.y;
}

function dragged() {
  d3.event.subject.fx = d3.event.x;
  d3.event.subject.fy = d3.event.y;
}

function dragended() {
  if (!d3.event.active) simulation.alphaTarget(0);
  d3.event.subject.fx = null;
  d3.event.subject.fy = null;
}

function drawLink(d) {
  context.moveTo(d.source.x, d.source.y);
  context.lineTo(d.target.x, d.target.y);
}

function drawNode(d) {
  context.moveTo(d.x + 3, d.y);
  context.arc(d.x, d.y, 3, 0, 2 * Math.PI);
}

</script>





