<!DOCTYPE html>
<meta charset="utf-8">
<canvas width="1960" height="1080"></canvas>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
let Json = [{"_id":"5caf26ca8fd84281dc60ecba","inst_name":"ins_64836343","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161573,"machine_id":"m_406","seq_no":1,"total_seq_no":1,"cpu_avg":87,"cpu_max":174,"mem_avg":0.24,"mem_max":0.44},{"_id":"5caf26ca8fd84281dc60ecca","inst_name":"ins_20101732","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161541,"machine_id":"m_3967","seq_no":1,"total_seq_no":1,"cpu_avg":96,"cpu_max":196,"mem_avg":0.24,"mem_max":0.44},{"_id":"5caf26ca8fd84281dc60ecd1","inst_name":"ins_101440340","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161550,"machine_id":"m_581","seq_no":1,"total_seq_no":1,"cpu_avg":93,"cpu_max":184,"mem_avg":0.24,"mem_max":0.44},{"_id":"5caf26ca8fd84281dc60ecd8","inst_name":"ins_101440247","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161561,"machine_id":"m_2963","seq_no":1,"total_seq_no":1,"cpu_avg":92,"cpu_max":185,"mem_avg":0.24,"mem_max":0.44},{"_id":"5caf26ca8fd84281dc60ecd9","inst_name":"ins_101439998","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161539,"machine_id":"m_3394","seq_no":1,"total_seq_no":1,"cpu_avg":101,"cpu_max":202,"mem_avg":0.25,"mem_max":0.44},{"_id":"5caf26ca8fd84281dc60ecdb","inst_name":"ins_1026859434","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161527,"machine_id":"m_1619","seq_no":1,"total_seq_no":1,"cpu_avg":106,"cpu_max":201,"mem_avg":0.26,"mem_max":0.45},{"_id":"5caf26ca8fd84281dc60ece8","inst_name":"ins_413112808","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161540,"machine_id":"m_3988","seq_no":1,"total_seq_no":1,"cpu_avg":98,"cpu_max":196,"mem_avg":0.25,"mem_max":0.44},{"_id":"5caf26ca8fd84281dc60eceb","inst_name":"ins_426858628","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161541,"machine_id":"m_1859","seq_no":1,"total_seq_no":1,"cpu_avg":99,"cpu_max":195,"mem_avg":0.24,"mem_max":0.43},{"_id":"5caf26ca8fd84281dc60ed09","inst_name":"ins_426858886","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161537,"machine_id":"m_1312","seq_no":1,"total_seq_no":1,"cpu_avg":102,"cpu_max":199,"mem_avg":0.24,"mem_max":0.43},{"_id":"5caf26ca8fd84281dc60ed0e","inst_name":"ins_264146369","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161524,"machine_id":"m_3071","seq_no":1,"total_seq_no":1,"cpu_avg":105,"cpu_max":202,"mem_avg":0.24,"mem_max":0.44},{"_id":"5caf26ca8fd84281dc60ed11","inst_name":"ins_136971528","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161573,"machine_id":"m_3862","seq_no":1,"total_seq_no":1,"cpu_avg":86,"cpu_max":182,"mem_avg":0.24,"mem_max":0.44},{"_id":"5caf26ca8fd84281dc60ed19","inst_name":"ins_508190437","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161598,"machine_id":"m_1581","seq_no":1,"total_seq_no":1,"cpu_avg":78,"cpu_max":167,"mem_avg":0.24,"mem_max":0.44},{"_id":"5caf26ca8fd84281dc60ed1a","inst_name":"ins_589502296","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161551,"machine_id":"m_960","seq_no":1,"total_seq_no":1,"cpu_avg":96,"cpu_max":190,"mem_avg":0.24,"mem_max":0.44},{"_id":"5caf26ca8fd84281dc60ed1b","inst_name":"ins_508189726","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161553,"machine_id":"m_3880","seq_no":1,"total_seq_no":1,"cpu_avg":93,"cpu_max":180,"mem_avg":0.24,"mem_max":0.43},{"_id":"5caf26ca8fd84281dc60ed25","inst_name":"ins_864217435","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161525,"machine_id":"m_1339","seq_no":1,"total_seq_no":1,"cpu_avg":96,"cpu_max":198,"mem_avg":0.26,"mem_max":0.45},{"_id":"5caf26ca8fd84281dc60ed2b","inst_name":"ins_218325099","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161548,"machine_id":"m_1231","seq_no":1,"total_seq_no":1,"cpu_avg":94,"cpu_max":184,"mem_avg":0.24,"mem_max":0.44},{"_id":"5caf26ca8fd84281dc60ed32","inst_name":"ins_1306343941","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161555,"machine_id":"m_3232","seq_no":1,"total_seq_no":1,"cpu_avg":90,"cpu_max":188,"mem_avg":0.24,"mem_max":0.43},{"_id":"5caf26ca8fd84281dc60ed3a","inst_name":"ins_784176342","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161532,"machine_id":"m_1700","seq_no":1,"total_seq_no":1,"cpu_avg":84,"cpu_max":185,"mem_avg":0.26,"mem_max":0.45},{"_id":"5caf26ca8fd84281dc60ed45","inst_name":"ins_182799018","task_name":"M6","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161554,"machine_id":"m_1486","seq_no":1,"total_seq_no":1,"cpu_avg":93,"cpu_max":186,"mem_avg":0.24,"mem_max":0.43},{"_id":"5caf26ca8fd84281dc60ed48","inst_name":"ins_784168774","task_name":"M6","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161525,"machine_id":"m_1330","seq_no":1,"total_seq_no":1,"cpu_avg":86,"cpu_max":176,"mem_avg":0.25,"mem_max":0.45},{"_id":"5caf26ca8fd84281dc60ed4c","inst_name":"ins_864217520","task_name":"M6","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161504,"machine_id":"m_2117","seq_no":1,"total_seq_no":1,"cpu_avg":104,"cpu_max":201,"mem_avg":0.26,"mem_max":0.45},{"_id":"5caf26ca8fd84281dc60ed4d","inst_name":"ins_818023712","task_name":"M6","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161519,"machine_id":"m_2109","seq_no":1,"total_seq_no":1,"cpu_avg":91,"cpu_max":186,"mem_avg":0.25,"mem_max":0.45},{"_id":"5caf26ca8fd84281dc60ed5e","inst_name":"ins_1108211827","task_name":"M6","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161540,"machine_id":"m_2667","seq_no":1,"total_seq_no":1,"cpu_avg":94,"cpu_max":185,"mem_avg":0.36,"mem_max":0.55},{"_id":"5caf26ca8fd84281dc60ed5f","inst_name":"ins_1108211488","task_name":"M6","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161574,"machine_id":"m_915","seq_no":1,"total_seq_no":1,"cpu_avg":89,"cpu_max":178,"mem_avg":0.26,"mem_max":0.45},{"_id":"5caf26ca8fd84281dc60ed67","inst_name":"ins_782887076","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161533,"machine_id":"m_1821","seq_no":1,"total_seq_no":1,"cpu_avg":90,"cpu_max":183,"mem_avg":0.26,"mem_max":0.45},{"_id":"5caf26ca8fd84281dc60ed75","inst_name":"ins_505989944","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161495,"machine_id":"m_3484","seq_no":1,"total_seq_no":1,"cpu_avg":103,"cpu_max":199,"mem_avg":0.25,"mem_max":0.45},{"_id":"5caf26ca8fd84281dc60ed81","inst_name":"ins_182798637","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161526,"machine_id":"m_2725","seq_no":1,"total_seq_no":1,"cpu_avg":103,"cpu_max":202,"mem_avg":0.24,"mem_max":0.44},{"_id":"5caf26ca8fd84281dc60ed8b","inst_name":"ins_1306344639","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161540,"machine_id":"m_674","seq_no":1,"total_seq_no":1,"cpu_avg":98,"cpu_max":197,"mem_avg":0.24,"mem_max":0.44},{"_id":"5caf26ca8fd84281dc60ed8e","inst_name":"ins_782886998","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161522,"machine_id":"m_1226","seq_no":1,"total_seq_no":1,"cpu_avg":95,"cpu_max":195,"mem_avg":0.26,"mem_max":0.45},{"_id":"5caf26ca8fd84281dc60ed91","inst_name":"ins_508189497","task_name":"M5","job_name":"j_3821991","task_type":"1","status":"Terminated","start_time":161359,"end_time":161527,"machine_id":"m_3086","seq_no":1,"total_seq_no":1,"cpu_avg":103,"cpu_max":199,"mem_avg":0.24,"mem_max":0.44}]
let nodesProcess = function(Json){

let exist = new Array();

let index = new Array()

// for(let i in list){
    // let field = 'inst_name';
//在开头插入一个源节点origin
// let origin = 'origin'
// index.unshift('origin')
// index.unshift(0)

//////////////////////////////
for(let j in Json){
    if(exist.indexOf(Json[j].inst_name )== -1){
        index.push(Json[j].inst_name);//小改改;
        exist.push(Json[j].inst_name);
    }
}
// }


for(let j in Json){
    if(exist.indexOf(Json[j].task_name )== -1){
        index.push(Json[j].task_name);//小改改;
        exist.push(Json[j].task_name);
    }
}



for(let j in Json){
    if(exist.indexOf(Json[j].job_name )== -1){
        index.push(Json[j].job_name);//小改改;
        exist.push(Json[j].job_name);
    }
}

//以下根据index数组构造映射表
    map = d3.range(index.length).map(function(i){
    return{
        tom :i,
        jerry:index[i]
    }
})

let data = new Array()
for(let a in index){
    let object = new Object()
    object.index = a;//要点：不用映射，直接写进去（因为之前也是按顺序的）
    data.push(object)
}
let nodes0 = JSON.stringify(data)
let dnodes = JSON.parse(nodes0)

console.log(index);
return dnodes;
}








let linksProcess = function(Json){

let exist = new Array();

//添加origin节点的link
let data0 = new Array();
// let obj0  = new Object();
// obj0.source = 0;
// obj0.target = 'origin';

// data0.push(obj0);
// for(let i in Json){
//     if(exist.indexOf(Json[i].job_name) == -1){
//         exist.push(Json[i].job_name)
//         let a = new Object();
//         a.source = 'origin';
//         a.target = Json[i].job_name;

//         data0.push(a)

//     }
// }



let data1 = new Array();

for(let i in Json){
    let job = Json[i].job_name;
    let task = Json[i].task_name;
    let a = new Object();
    a.source = job;
    a.target = task;

    data1.push(a);


}

    let data2 = data0.concat(data1)

let data3 = new Array();
for(let i in Json){
    let task = Json[i].task_name;
    let instance = Json[i].inst_name;
    let a = new Object();
    a.source = task;
    a.target = instance;

    data3.push(a);
}
let data = data2.concat(data3)



let links0 = JSON.stringify(data);
let links = JSON.parse(links0);

//对links去重，赋值给dlinks
let source = new Array();	
let target = new Array();

let dlinks = new Array();

for(let k = 0;k<links.length;k++){

if((source.indexOf(links[k].source) > -1)&(target.indexOf(links[k].target) > -1)){

}else{
    source.push(links[k].source);
    target.push(links[k].target);
    dlinks.push(links[k])

}
}

//以下把links根据映射表来映射
for(let i=0;i<dlinks.length;i++){
    for(let j=0;j<map.length;j++){
        if(dlinks[i].source == map[j].jerry){
            dlinks[i].source = map[j].tom;
        }else{

        }

        if(dlinks[i].target == map[j].jerry){
            dlinks[i].target = map[j].tom;
        }else{
            
        }
    }
}


console.log(map);
console.log(dlinks);

return dlinks;

}


let nodes = nodesProcess(Json)
let links = linksProcess(Json)

console.log(nodes);
console.log(links);


let simulation = d3.forceSimulation(nodes)
    .force("charge", d3.forceManyBody())
    .force("link", d3.forceLink(links).distance(20).strength(1))
    .force("x", d3.forceX())
    .force("y", d3.forceY())
    .on("tick", ticked);

let canvas = document.querySelector("canvas"),
    context = canvas.getContext("2d"),
    width = canvas.width,
    height = canvas.height;

d3.select(canvas)
    .call(d3.drag()
        .container(canvas)
        .subject(dragsubject)
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended));

function ticked() {
  context.clearRect(0, 0, width, height);
  context.save();
  context.translate(width / 2, height / 2);

  context.beginPath();
  links.forEach(drawLink);
  context.strokeStyle = "#aaa";
  context.stroke();

  context.beginPath();
  nodes.forEach(drawNode);
  context.fill();
  context.strokeStyle = "#fff";
  context.stroke();

  context.restore();
}

function dragsubject() {
  return simulation.find(d3.event.x - width / 2, d3.event.y - height / 2);
}

function dragstarted() {
  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
  d3.event.subject.fx = d3.event.subject.x;
  d3.event.subject.fy = d3.event.subject.y;
}

function dragged() {
  d3.event.subject.fx = d3.event.x;
  d3.event.subject.fy = d3.event.y;
}

function dragended() {
  if (!d3.event.active) simulation.alphaTarget(0);
  d3.event.subject.fx = null;
  d3.event.subject.fy = null;
}

function drawLink(d) {
  context.moveTo(d.source.x, d.source.y);
  context.lineTo(d.target.x, d.target.y);
}

function drawNode(d) {
  context.moveTo(d.x + 3, d.y);
  context.arc(d.x, d.y, 3, 0, 2 * Math.PI);
}

</script>





